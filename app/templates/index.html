<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Assistant - Control Panel</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Interview Assistant</h1>
            <p>Get real-time prompts during your interviews</p>
        </div>

        <div class="main-content">
            <!-- Left Column - Session Setup -->
            <div class="card">
                <h2>üìã Create Session</h2>
                <div class="form-group">
                    <label for="userName">Your Name</label>
                    <input type="text" id="userName" placeholder="Enter your full name" autocomplete="off">
                </div>
                <button class="btn" onclick="createSession()" id="createBtn">
                    <span>Create New Session</span>
                </button>
                <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
            </div>

            <!-- Right Column - Session Info -->
            <div class="card" id="sessionInfo" style="display: none;">
                <h2>üîó Session Active</h2>

                <div class="status-indicator" id="statusIndicator">
                    <div class="loading"></div>
                    <span>Waiting for phone connection...</span>
                </div>

                <div class="qr-section">
                    <h3>Scan QR Code to Connect</h3>
                    <div class="qr-container">
                        <div id="qrCode"></div>
                    </div>

                    <div class="url-box">
                        <p>Or open this URL on your phone:</p>
                        <a id="joinUrl" target="_blank" rel="noopener"></a>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="startAudioCapture()" id="shareScreenBtn" disabled>
                        üé§ Share Screen & Start Audio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionSocket;
        let currentSessionId = null;

        async function createSession() {
            const userName = document.getElementById('userName').value.trim();
            const createBtn = document.getElementById('createBtn');
            const errorAlert = document.getElementById('errorAlert');

            // Hide any previous errors
            errorAlert.style.display = 'none';

            if (!userName) {
                showError('Please enter your name');
                return;
            }

            // Show loading state
            createBtn.innerHTML = '<div class="loading"></div><span>Creating Session...</span>';
            createBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('user_name', userName);

                const response = await fetch('/create_session', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const data = await response.json();
                currentSessionId = data.session_id;

                // Show session info
                document.getElementById('sessionInfo').style.display = 'block';

                // Display QR Code
                const qrCodeEl = document.getElementById('qrCode');
                qrCodeEl.innerHTML = '';
                const img = document.createElement('img');
                img.src = data.qr_code_data;
                img.alt = "QR Code to join session";
                qrCodeEl.appendChild(img);

                // Display join URL
                const joinUrlEl = document.getElementById('joinUrl');
                joinUrlEl.href = data.join_url;
                joinUrlEl.textContent = data.join_url;

                // Connect to WebSocket
                connectSessionWebSocket(currentSessionId);

            } catch (error) {
                console.error('Failed to create session:', error);
                showError(error.message || 'Failed to create session. Please try again.');
            } finally {
                // Reset button state
                createBtn.innerHTML = '<span>Create New Session</span>';
                createBtn.disabled = false;
            }
        }

        function connectSessionWebSocket(sessionId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}/desktop`;

            sessionSocket = new WebSocket(wsUrl);

            sessionSocket.onopen = function (event) {
                console.log("WebSocket connection established for session control.");
                updateStatus('waiting', 'Waiting for phone connection...');
            };

            sessionSocket.onmessage = function (event) {
                console.log("Message from server:", event.data);

                if (event.data === "mobile_connected") {
                    updateStatus('connected', 'Phone connected! ‚úÖ');
                    document.getElementById('shareScreenBtn').disabled = false;
                } else if (event.data === "mobile_disconnected") {
                    updateStatus('waiting', 'Phone disconnected. Waiting for connection...');
                    document.getElementById('shareScreenBtn').disabled = true;
                }
            };

            sessionSocket.onclose = function (event) {
                console.log("WebSocket connection closed.");
                updateStatus('disconnected', 'Connection lost. Please refresh the page.');
                document.getElementById('shareScreenBtn').disabled = true;
            };

            sessionSocket.onerror = function (error) {
                console.error("WebSocket error:", error);
                showError('WebSocket connection failed. Please refresh the page.');
            };
        }

        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.innerHTML = '';

            if (status === 'connected') {
                indicator.className = 'status-indicator status-connected';
                indicator.innerHTML = `‚úÖ <span>${message}</span>`;
            } else if (status === 'disconnected') {
                indicator.className = 'status-indicator status-disconnected';
                indicator.innerHTML = `‚ùå <span>${message}</span>`;
            } else {
                indicator.className = 'status-indicator status-waiting';
                indicator.innerHTML = '<div class="loading"></div><span>' + message + '</span>';
            }
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        function startAudioCapture() {
            // This will be implemented in Phase 2
            alert('Audio capture starting... (Feature not yet implemented)');
        }

        // Handle page refresh/closing
        window.addEventListener('beforeunload', function () {
            if (sessionSocket) {
                sessionSocket.close();
            }
        });
    </script>
</body>

</html>

</html>