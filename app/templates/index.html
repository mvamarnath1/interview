<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Assistant - Control Panel</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Interview Assistant</h1>
            <p>Get real-time prompts during your interviews</p>
        </div>

        <div class="main-content">
            <!-- Left Column - Session Setup -->
            <div class="card">
                <h2>üìã Create Session</h2>
                <div class="form-group">
                    <label for="userName">Your Name</label>
                    <input type="text" id="userName" placeholder="Enter your full name" autocomplete="off">
                </div>
                <button class="btn" onclick="createSession()" id="createBtn">
                    <span>Create New Session</span>
                </button>
                <div id="errorAlert" class="alert alert-error" style="display: none;"></div>
            </div>

            <!-- Right Column - Session Info -->
            <div class="card" id="sessionInfo" style="display: none;">
                <h2>üîó Session Active</h2>

                <div class="status-indicator" id="statusIndicator">
                    <div class="loading"></div>
                    <span>Waiting for phone connection...</span>
                </div>

                <div class="pin-section">
                    <div class="pin-container"
                        style="text-align: center; margin: 1rem 0; padding: 2rem; background: #374151; border-radius: 12px;">
                        <h3 style="margin: 0 0 1rem 0; color: #fbbf24;">üì± Quick Join PIN</h3>
                        <div id="pinCode"
                            style="font-size: 3rem; font-weight: bold; color: #10b981; letter-spacing: 0.3em; margin: 1rem 0;"></div>
                        <p style="margin: 1rem 0 0 0; font-size: 1.1rem; color: #94a3b8;">
                            Go to <strong style="color: #10b981;" id="joinUrlDisplay">loading...</strong> on mobile and enter this PIN
                        </p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #64748b; font-style: italic;">
                            üí° Mobile devices will automatically be redirected to the mobile interface
                        </p>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="startAudioCapture()" id="shareScreenBtn" disabled>
                        üé§ Share Screen & Start Audio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sessionSocket;
        let currentSessionId = null;
        let baseUrl = '';

        // Fetch the correct base URL when page loads
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                baseUrl = config.base_url;
                
                // Update the join URL display
                const joinUrlDisplay = document.getElementById('joinUrlDisplay');
                if (joinUrlDisplay) {
                    joinUrlDisplay.textContent = config.join_url;
                }
            } catch (error) {
                console.error('Failed to load config:', error);
                baseUrl = window.location.origin; // fallback
            }
        }

        // Load config when page loads
        document.addEventListener('DOMContentLoaded', loadConfig);

        async function createSession() {
            const userName = document.getElementById('userName').value.trim();
            const createBtn = document.getElementById('createBtn');
            const errorAlert = document.getElementById('errorAlert');

            // Hide any previous errors
            errorAlert.style.display = 'none';

            if (!userName) {
                showError('Please enter your name');
                return;
            }

            // Show loading state
            createBtn.innerHTML = '<div class="loading"></div><span>Creating Session...</span>';
            createBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('user_name', userName);

                const response = await fetch('/create_session', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const data = await response.json();
                currentSessionId = data.session_id;

                // Show session info
                document.getElementById('sessionInfo').style.display = 'block';

                // Display PIN Code
                const pinCodeEl = document.getElementById('pinCode');
                pinCodeEl.textContent = data.pin_code;

                // Connect to WebSocket
                connectSessionWebSocket(currentSessionId);

            } catch (error) {
                console.error('Failed to create session:', error);
                showError(error.message || 'Failed to create session. Please try again.');
            } finally {
                // Reset button state
                createBtn.innerHTML = '<span>Create New Session</span>';
                createBtn.disabled = false;
            }
        }

        function connectSessionWebSocket(sessionId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${sessionId}/desktop`;

            sessionSocket = new WebSocket(wsUrl);

            sessionSocket.onopen = function (event) {
                console.log("WebSocket connection established for session control.");
                updateStatus('waiting', 'Waiting for phone connection...');
            };

            sessionSocket.onmessage = function (event) {
                console.log("Message from server:", event.data);

                if (event.data === "mobile_connected") {
                    updateStatus('connected', 'Phone connected! ‚úÖ');
                    document.getElementById('shareScreenBtn').disabled = false;
                } else if (event.data === "mobile_disconnected") {
                    updateStatus('waiting', 'Phone disconnected. Waiting for connection...');
                    document.getElementById('shareScreenBtn').disabled = true;
                } else {
                    // Handle JSON messages for screen sharing
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'screen_share_started') {
                            console.log('Screen sharing started');
                        } else if (message.type === 'screen_share_stopped') {
                            console.log('Screen sharing stopped');
                        } else if (message.type === 'audio_processed') {
                            console.log('Audio processed:', message.transcription);
                        }
                    } catch (e) {
                        // Handle non-JSON messages (legacy)
                        console.log("Received message:", event.data);
                    }
                }
            };

            sessionSocket.onclose = function (event) {
                console.log("WebSocket connection closed.");
                updateStatus('disconnected', 'Connection lost. Please refresh the page.');
                document.getElementById('shareScreenBtn').disabled = true;
            };

            sessionSocket.onerror = function (error) {
                console.error("WebSocket error:", error);
                showError('WebSocket connection failed. Please refresh the page.');
            };
        }

        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            indicator.innerHTML = '';

            if (status === 'connected') {
                indicator.className = 'status-indicator status-connected';
                indicator.innerHTML = `‚úÖ <span>${message}</span>`;
            } else if (status === 'disconnected') {
                indicator.className = 'status-indicator status-disconnected';
                indicator.innerHTML = `‚ùå <span>${message}</span>`;
            } else {
                indicator.className = 'status-indicator status-waiting';
                indicator.innerHTML = '<div class="loading"></div><span>' + message + '</span>';
            }
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        function startAudioCapture() {
            console.log("startAudioCapture called - " + new Date().toISOString());
            startScreenShare();
        }

        // Screen sharing functionality
        let screenStream = null;

        async function startScreenShare() {
            console.log("startScreenShare called - " + new Date().toISOString());
            try {
                // Request screen sharing with audio
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor" // Can be "monitor", "window", or "application"
                    },
                    audio: true // Enable audio capture
                });

                // Show screen share controls
                showScreenShareControls();

                // Handle when user stops sharing
                screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                    stopScreenShare();
                });

                // Update UI
                document.getElementById('shareScreenBtn').textContent = 'üî¥ Stop Sharing';
                document.getElementById('shareScreenBtn').onclick = stopScreenShare;

                // Notify via WebSocket
                if (sessionSocket && sessionSocket.readyState === WebSocket.OPEN) {
                    sessionSocket.send(JSON.stringify({
                        type: 'screen_share_started',
                        message: 'Screen sharing started'
                    }));
                }

                // Start audio processing if audio track is available
                startAudioProcessing();

            } catch (error) {
                console.error('Error starting screen share:', error);
                if (error.name === 'NotAllowedError') {
                    showError('Screen sharing permission denied. Please allow screen sharing to continue.');
                } else if (error.name === 'NotSupportedError') {
                    showError('Screen sharing is not supported in this browser. Please use Chrome, Firefox, or Edge.');
                } else {
                    showError('Failed to start screen sharing: ' + error.message);
                }
            }
        }

        function showScreenShareControls() {
            // Create or show screen share controls
            let controlsContainer = document.getElementById('screenShareControls');
            if (!controlsContainer) {
                controlsContainer = document.createElement('div');
                controlsContainer.id = 'screenShareControls';
                controlsContainer.className = 'screen-share-controls';
                controlsContainer.innerHTML = `
                    <div class="share-status">
                        <div class="recording-indicator">üî¥ Screen Sharing Active</div>
                    </div>
                    <div class="share-actions">
                        <button class="btn btn-danger" onclick="stopScreenShare()" id="stopBtn">
                            ‚èπÔ∏è Stop Sharing
                        </button>
                    </div>
                `;

                // Insert after the session info card
                const sessionInfo = document.getElementById('sessionInfo');
                sessionInfo.parentNode.insertBefore(controlsContainer, sessionInfo.nextSibling);
            }
            controlsContainer.style.display = 'block';
        }

        function stopScreenShare() {
            try {
                // Stop audio processing first
                stopAudioProcessing();

                // Stop all tracks
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                    screenStream = null;
                }

                // Hide controls
                const controlsContainer = document.getElementById('screenShareControls');
                if (controlsContainer) {
                    controlsContainer.style.display = 'none';
                }

                // Reset button
                document.getElementById('shareScreenBtn').textContent = 'üé§ Share Screen';
                document.getElementById('shareScreenBtn').onclick = startAudioCapture;

                // Notify via WebSocket
                if (sessionSocket && sessionSocket.readyState === WebSocket.OPEN) {
                    sessionSocket.send(JSON.stringify({
                        type: 'screen_share_stopped',
                        message: 'Screen sharing stopped'
                    }));
                }

            } catch (error) {
                console.error('Error stopping screen share:', error);
            }
        }

        // Audio processing functionality
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let audioProcessor = null;

        function startAudioProcessing() {
            if (!screenStream) return;

            const audioTracks = screenStream.getAudioTracks();
            if (audioTracks.length === 0) {
                console.log('No audio track available in screen share');
                return;
            }

            try {
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create audio source from screen share
                const audioStream = new MediaStream(audioTracks);
                microphone = audioContext.createMediaStreamSource(audioStream);

                // Create analyser for audio processing
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // Connect audio nodes
                microphone.connect(analyser);

                // Create script processor for audio chunks
                const bufferSize = 4096;
                audioProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);

                let audioBuffer = [];
                let lastSentTime = Date.now();
                const SEND_INTERVAL = 250; // Send audio every 250ms for ultra-fast response

                audioProcessor.onaudioprocess = function (event) {
                    const inputBuffer = event.inputBuffer;
                    const inputData = inputBuffer.getChannelData(0);

                    // Add to buffer
                    audioBuffer.push(...inputData);

                    // Send audio chunk every SEND_INTERVAL milliseconds
                    if (Date.now() - lastSentTime > SEND_INTERVAL && audioBuffer.length > 0) {
                        sendAudioChunk(audioBuffer);
                        audioBuffer = [];
                        lastSentTime = Date.now();
                    }
                };

                // Connect processor
                analyser.connect(audioProcessor);
                audioProcessor.connect(audioContext.destination);

                console.log('Audio processing started');

            } catch (error) {
                console.error('Error starting audio processing:', error);
            }
        }

        function sendAudioChunk(audioBuffer) {
            if (!sessionSocket || sessionSocket.readyState !== WebSocket.OPEN) return;

            try {
                // Convert float32 audio to 16-bit PCM
                const pcmBuffer = new Int16Array(audioBuffer.length);
                for (let i = 0; i < audioBuffer.length; i++) {
                    pcmBuffer[i] = Math.max(-32768, Math.min(32767, audioBuffer[i] * 32767));
                }

                // Create WAV header
                const wavBuffer = createWAVBuffer(pcmBuffer, 44100);

                // Convert to base64
                const base64Audio = btoa(String.fromCharCode(...new Uint8Array(wavBuffer)));

                // Send via WebSocket
                const audioMessage = {
                    type: 'audio_chunk',
                    data: base64Audio
                };

                sessionSocket.send(JSON.stringify(audioMessage));
                console.log('Audio chunk sent');

            } catch (error) {
                console.error('Error sending audio chunk:', error);
            }
        }

        function createWAVBuffer(pcmBuffer, sampleRate) {
            const length = pcmBuffer.length;
            const buffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(buffer);

            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);

            // PCM data
            let offset = 44;
            for (let i = 0; i < length; i++) {
                view.setInt16(offset, pcmBuffer[i], true);
                offset += 2;
            }

            return buffer;
        }

        function stopAudioProcessing() {
            try {
                if (audioProcessor) {
                    audioProcessor.disconnect();
                    audioProcessor = null;
                }
                if (microphone) {
                    microphone.disconnect();
                    microphone = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                console.log('Audio processing stopped');
            } catch (error) {
                console.error('Error stopping audio processing:', error);
            }
        }

        // Handle page refresh/closing
        window.addEventListener('beforeunload', function () {
            if (sessionSocket) {
                sessionSocket.close();
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>

</html>
});
</script>
</body>

</html>

</html>